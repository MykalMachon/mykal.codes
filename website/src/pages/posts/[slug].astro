---
import Layout from '@components/layout/Layout.astro';
import ResponsiveImage from '@components/layout/ResponsiveImage.astro';
import PostAttributes from '@components/posts/PostAttributes.astro';
import PostTOC from '@components/posts/PostTOC.astro';
import { getCollection } from 'astro:content';

export const prerender = true;
export async function getStaticPaths({}) {
  let allPosts = await getCollection('posts');

  return allPosts.map((post) => {
    return {
      params: { slug: post.slug },
      props: { post },
    };
  });
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const hasSplitLayout = headings.length != 0;
---

<Layout title={post.data.title} description={post.data.description}>
  <div class={`post-layout ${hasSplitLayout ? 'post-layout--split' : ''}`}>
    <header data-pagefind-body>
      <h1>{post.data.title}</h1>
      <p class="byline">{post.data.description}</p>
      <PostAttributes post={post} />

      {
        post.data.heroImage ? (
          <ResponsiveImage
            src={post.data.heroImage}
            alt=""
            sizes={[400, 700, 900]}
            format="avif"
          />
        ) : null
      }
    </header>
    <main data-pagefind-body>
      <Content />
    </main>
    <aside>
      {
        headings.length != 0 ? (
          <section class="post-toc">
            <h2>Table of contents</h2>
            <PostTOC toc={headings} />
          </section>
        ) : null
      }
    </aside>
    <footer>
      {
        post.data.tags && post.data.tags.length != 0 ? (
          <section id="tags" class="post-tags">
            <ul>
              {post.data.tags.map((tag: string) => (
                <li>
                  <a href={`/tags/${tag}`}>#{tag}</a>
                </li>
              ))}
            </ul>
          </section>
        ) : null
      }
    </footer>
  </div>
</Layout>

<style>
  .post-layout {
    width: 100%;
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--size-4);
  }

  .post-layout.post-layout--split {
    grid-template-columns: minmax(60ch, 2fr) 1fr;
  }

  header {
    grid-column: 1 / -1;
    border-bottom: 1px solid var(--gray-5);
  }

  footer {
    grid-column: 1 / -1;
    padding: var(--size-4) 0;
    border-top: 1px solid var(--gray-5);
  }

  header section.post-tags {
    margin-top: var(--size-6);
  }

  header .byline {
    font-family: var(--font-heading);
    font-size: var(--font-size-md);
    color: var(--gray-8);
  }

  aside {
    position: sticky;
    top: 0;
    height: fit-content;
  }

  aside section h2 {
    font-size: var(--font-size-base);
    margin: 0;
    padding: var(--size-4) 0;
    margin-bottom: var(--size-4);
    border-bottom: 1px solid var(--gray-5);
  }

  .post-tags ul {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: var(--size-3);
  }

  .post-tags ul li {
    padding: var(--size-1);
    background: var(--gray-3);
    border-radius: var(--radius-2);
  }

  .post-tags ul li a {
    font-size: var(--font-size-sm);
  }

  @media screen and (max-width: 950px) {
    header {
      grid-area: header;
    }
    main {
      grid-area: main;
    }
    aside {
      grid-area: aside;
    }

    aside {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--size-4);
    }

    aside section h2 {
      padding: var(--size-4) 0;
      padding-top: 0;
    }

    .post-tags ul li a {
      font-size: var(--font-size-base);
    }

    .post-layout, .post-layout.post-layout--split {
      grid-template-columns: 1fr;
      grid-template-areas:
        'header'
        'aside'
        'main';
    }
    aside {
      position: relative;
      top: auto;
      height: auto;
    }
  }
</style>
